<html>

<head>
    <title>Raleigh Bikeways</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css' rel='stylesheet' />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <script src=" https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js">
    </script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css"
        type="text/css" />

    <!-- Flavicon Metadata -->
    <link rel="apple-touch-icon" sizes="76x76" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-142487885-3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-142487885-3');
    </script>
</head>

<body>
    <!-- <div id="header">
        <div id="title">Raleigh Bikeways</div>
        <div id="info-icon-container" onclick="document.getElementById('info-box-container').style.display='block'">
            <i class="material-icons md-36 noselect">info</i>
        </div>
    </div> -->
    <div id="info-icon-container" onclick="document.getElementById('info-box-container').style.display='block'">
        <i class="material-icons md-36 md-light noselect">info</i>
    </div>
    <div id="direction-buttons" style="display: none;">
        <i class="material-icons md-36 md-light noselect" id="curr-location-nav"
            onclick="setNavOrigin()">my_location</i>
        <i class=" material-icons md-36 md-light noselect" onclick="toggleDirectionSection()">visibility_off</i>
    </div>
    <div id="show-directions-container">
        <i class=" material-icons md-48 md-light noselect" onclick="toggleDirectionSection()">navigation</i>
        <br>
        <span>NAV</span>
    </div>
    <div id="info-box-container" class="modal-container" onclick="this.style.display='none'" style="display: none;">
        <div id="info-box" class="modal" onclick="event.stopPropagation()">
            <div>
                <b>Raleigh Bikeways</b>
                <i class=" material-icons md-24 noselect close-button"
                    onclick="document.getElementById('info-box-container').style.display='none'">close</i>
            </div>
            <div>An
                <a href="https://github.com/oaksandspokes/raleighbikeways" target="_blank">open</a> source
                <a href="https://oaksandspokes.com" target="_blank">community</a>
                built bike navigation site built on open data to help you get around on a bike.
            </div>
            <table>
                <tr>
                    <td>
                        <input id="greenway-checkbox" type="checkbox" class="legend-checkbox" onchange="legendToggleGreenwayLayer(this.checked);"
                            checked>Greenways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="" name="closed-greenways-layer"
                            disabled style="visibility: hidden;">Closed Greenways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-closed-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="greenway-dashed-checkbox" type="checkbox" class="legend-checkbox" onchange="legendToggleGreenwayDashedLayer(this.checked);"
                            checked>Marginal Greenways
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('marginal-greenway-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-legend">
                            <line x1="0" y1="5" x2="20" y2="5" />
                            <line x1="40" y1="5" x2="60" y2="5" />
                            <line x1="80" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="greenway-detour-checkbox" type="checkbox" class="legend-checkbox" 
                            onchange="legendToggleGreenwayDetourLayer(this.checked)" checked />Greenway Detours
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('greenway-detour-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-detour-legend">
                            <line x1="0" y1="5" x2="20" y2="5" />
                            <line x1="40" y1="5" x2="60" y2="5" />
                            <line x1="80" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="facilities-checkbox" type="checkbox" class="legend-checkbox" onchange="legendToggleFacilitiesLayer(this.checked);"
                            checked>Bike lanes / Sidepaths
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('bike-lane-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="existing-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="facilities-dashed-checkbox" type="checkbox" class="legend-checkbox"
                            onchange="legendToggleDashedFacilitiesLayer(this.checked);" checked>Recommended Paths
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('recommended-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="10" width="100" class="existing-legend">
                            <line x1="0" y1="5" x2="20" y2="5" />
                            <line x1="40" y1="5" x2="60" y2="5" />
                            <line x1="80" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="programmed-checkbox" type="checkbox" class="legend-checkbox" onchange="legendToggleProgrammedLayer(this.checked)"
                            checked>Planned Bikeways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="programmed-legend">
                            <line x1="0" y1="5" x2="100" y2="5" />
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id="citrix-checkbox" type="checkbox" class="legend-checkbox" onchange="legendToggleCitrixLayer(this.checked)"
                            checked>Citrix Cycle Stations
                        <i class="material-icons md-18 noselect"
                            onclick="document.getElementById('citrix-info-container').style.display='block'">info</i>
                    </td>
                    <td>
                        <svg height="24" width="24" class="existing-legend">
                            <circle cx="12" cy="12" r="10" stroke="black" stroke-width="2" fill="red" />
                        </svg>
                    </td>
                </tr>
            </table>
            <div id="feedback-button-container">
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSeROy90gU_08wwKrasKIGHE4b-uOOUdohYK6ClDtKLd4zvQ1Q/viewform?usp=sf_link"
                    target="_blank" class="button">
                    We Love Feedback!
                </a>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div id="marginal-greenway-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="marginal-greenway-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('marginal-greenway-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Marginal Greenways</div>
                <span>
                    We have set marginal greenways to be any greenway that is unpaved or less than 7 feet wide.
                </span>
                <br>
                <img src="img/marginal-greenway-1.jpg" width="300" />
                <img src="img/marginal-greenway-2.jpg" width="300" />
            </div>
            <br>
        </div>
    </div>
    <div id="greenway-detour-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="greenway-detour-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('greenway-detour-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Greenway Detours</div>
                <span>
                    Community recommended ways to avoid greenway closures. These may take you on sidewalks, bike lanes,
                    or calm neighborhoods.
                    Find out more about greenway closures in Raleigh from the <a
                        href="https://raleighnc.gov/home/content/PRecDesignDevelop/Articles/GreenwayRepairs.html"
                        target="_blank">city.</a>
                </span>
                <br>
            </div>
        </div>
    </div>
    <div id="bike-lane-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="bike-lane-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('bike-lane-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Bike Lanes / Side Paths</div>
                <span>
                    Bike lanes on the road, as well as side paths next to the road
                </span>
                <br>
                <img src="img/sidepath.jpg" width="300" />
            </div>
        </div>
    </div>
    <div id="recommended-info-container" class="modal-container" onclick="this.style.display='none'"
        style="display: none;">
        <div id="recommended-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('recommended-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Recommended Paths</div>
                <span>
                    Roads without dedicated bike infrastructure, but found to be fairly comfortable to bike on.
                    Generally they have a speed limit of 25 mph or less with low traffic volumes.
                </span>
                <br>
            </div>
        </div>
    </div>
    <div id="citrix-info-container" class="modal-container" onclick="this.style.display='none'" style="display: none;">
        <div id="citrix-info" class="modal legend-info" onclick="event.stopPropagation()">
            <i class=" material-icons md-24 noselect close-button"
                onclick="document.getElementById('citrix-info-container').style.display='none'">close</i>
            <div id="about">
                <div class="legend-info-title">Citrix Cycle</div>
                <span>
                    Raleigh's docked bike share programming, including some electric assist bikes! Find out more at
                    <a href="https://www.citrixcycle.com" target="_blank">citrixcycle.com</a>
                </span>
                <br>
                <img src="img/citrix.jpg" width="500" />
            </div>
            <br>
        </div>
    </div>
    </div>

</body>

<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoib2Frc2FuZHNwb2tlcyIsImEiOiJjazR1M2Ztc3cwZXl2M21ub3p6eXF3b2txIn0.BNI4-QbP-094byFujTJAuQ'

    const colors = {
        CITRIX: '#f9423a',
        PROGRAMMED: '#3498DB',
        GREENWAY: '#28B463',
        GREENWAY_CLOSED: '#CC0000',
        GREENWAY_CLOSED_X: '#FF0000',
        GREENWAY_DETOUR: 'yellow',
        EXISTING: '#EEE',
    }

    const layers = {
        EXISTING: "existing-bike-facilities-layer",
        EXISTING_DASHED: "existing-bike-facilities-dashed-layer",
        PROGRAMMED: "programmed-bike-facilities-layer",
        PROGRAMMED_DASHED: "programmed-bike-facilities-dashed-layer",
        RALEIGH_GREENWAY: "existing-raleigh-greenways-layer",
        RALEIGH_GREENWAY_DASHED: "existing-raleigh-greenways-dashed-layer",
        RALEIGH_GREENWAY_SYMBOL: "raleigh-greenway-symbol-layer",
        RALEIGH_GREENWAY_NAME: "raleigh-greenway-name-layer",
        CARY_GREENWAY: "cary-greenways-layer",
        CARY_GREENWAY_DASHED: "cary-greenways-dashed-layer",
        CARY_GREENWAY_NAME: "cary-greenway-name-layer",
        GREENWAY_DETOUR: "greenway-detour-layer",
        CARY_BIKES: "cary-bikes-layer",
        CARY_BIKES_DASHED: "cary-bikes-dashed-layer",
        CITRIX: 'citrix-cycle-stations-layer',
        UMSTEAD: 'umstead-trails-layer',
        DURHAM_FACILITIES: 'durham-facilities-layer',
        DURHAM_FACILITIES_DASHED: 'durham-dashed-facilities-layer',
        DURHAM_GREENWAY: 'durham-greenway-layer',
        MINGO_GREENWAY: 'mingo-greenway-layer',
        MINGO_GREENWAY_NAMES: 'mingo-greenway-names-layer',
        SMITH_GREENWAY: 'smith-greenway-layer',
        SMITH_GREENWAY_NAMES: 'smith-greenway-names-layer',
        CH_CARR_FACILITIES: 'chapel-hill-carrboro-facilities',
        CH_CARR_FACILITIES_DASHED: 'chapel-hill-carrboro-facilities-dashed',
        CH_CARR_GREENWAY: 'chapel-hill-carrboro-greenway',
        CH_CARR_GREENWAY_DASHED: 'chapel-hill-carrboro-greenway-dashed',

    }

    const sources = {
        RALEIGH_GREENWAY: "existing-greenways-raleigh",
        CARY_GREENWAY: "cary-greenways",
        GREENWAY_DETOUR: 'greenway-detour',
        CARY_BIKES: "cary-bikes",
        EXISTING_FACILITIES: "existing-bike-facilities",
        PROGRAMMED_FACILITIES: "programmed-bike-facilities",
        CITRIX: "citrix-cycle-stations",
        UMSTEAD: 'umstead-trails',
        DURHAM_SOLID: 'durham-solid',
        DURHAM_DASHED: 'durham-dashed',
        MINGO_GREENWAY: 'mingo-greenway',
        SMITH_GREENWAY: 'smith-greenway',
        CH_CARRBORO: 'chapel-hill-carrboro',
    }

    // Custom styling for the direction line
    // Make it see through so user can see the bike infrastructure. 
    const directionsStyling = [{
        'id': 'directions-route-line',
        'type': 'line',
        'source': 'directions',
        'layout': {
            'line-cap': 'butt',
            'line-join': 'round'
        },
        'paint': {
            'line-color': {
                'property': 'congestion',
                'type': 'categorical',
                'default': '#4882c5',
                'stops': [
                    ['unknown', '#4882c5'],
                    ['low', '#4882c5'],
                    ['moderate', '#f09a46'],
                    ['heavy', '#e34341'],
                    ['severe', '#8b2342']
                ]
            },
            'line-width': 7,
            'line-opacity': .5
        },
        'filter': [
            'all',
            ['in', '$type', 'LineString'],
            ['in', 'route', 'selected']
        ]
    }, {
        'id': 'directions-route-line-casing',
        'type': 'line',
        'source': 'directions',
        'layout': {
            'line-cap': 'round',
            'line-join': 'round'
        },
        'paint': {
            'line-color': '#2d5f99',
            'line-width': 12,
            'line-opacity': .5
        },
        'filter': [
            'all',
            ['in', '$type', 'LineString'],
            ['in', 'route', 'selected']
        ]
    }];


    let map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/peterboyer/cjr49i1ql0mza2srxxtgqlpqw',
        center: [-78.638176, 35.779591],
        zoom: 12
    });

    map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

    const geolocateControl = new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true,
            maximumAge: 1000,
        },
        trackUserLocation: true
    })

    let lastFoundPosition;

    geolocateControl.on('geolocate', (geoPos) => {
        lastFoundPosition = [geoPos.coords.longitude, geoPos.coords.latitude];
    })

    geolocateControl.on('error', (err) => {
        console.warn(err.message);
        if (err.code == 1) {
            window.alert("Geolocation permission was denied, please enable to use")
        }
    })

    map.addControl(geolocateControl, 'bottom-right');

    let showingDirections = false;
    let showingDirectionsSection = false;

    const directionContol = new MapboxDirections({
        accessToken: mapboxgl.accessToken,
        profile: "mapbox/cycling",
        styles: directionsStyling,
        interactive: false,
        controls: {
            profileSwitcher: false,

        },
        geocoder: {
            bbox: "-81,34,-76,37", // bounding box for search results
            proximity: "-78.6397933959961,35.77966399144513",
        }
    })

    map.addControl(directionContol, 'top-left');

    // Function to help build a query string for querying the ArcGIS REST service
    function queryString(queryProperties) {
        let queryString = '';
        for (let property in queryProperties) {
            queryString += `${property}=${queryProperties[property].toString()}&`
        }
        return queryString.slice(0, -1)
    }

    // REST endpoint for a dataset published to an ArcGIS Server. In this case, it was published to an ArcGIS Online ArcGIS Server 
    let existingRaleighGreenwaysURL = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Greenway_Trails_All/FeatureServer/0';
    let caryGreenwaysURL = 'https://maps.townofcary.org/arcgis1/rest/services/OpenData/MapServer/17';
    let caryBikeURL = 'https://maps.townofcary.org/arcgis1/rest/services/OpenData/MapServer/16';
    let existingBikeFacilities = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Existing_Bike_Facilities/FeatureServer/6';
    let programmedBikeFacilities = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Programmed_Bike_Facilities/FeatureServer/6';
    let citrixCycleStations = 'https://services.arcgis.com/v400IkDOw1ad7Yad/arcgis/rest/services/Citrix_Cycle_Stations/FeatureServer/0';
    let umsteadURL = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/BikeRaleigh_Map_2019_Online_WFL1/FeatureServer/13';
    let durhamURL = 'https://webgis.durhamnc.gov/server/rest/services/OpenData/Bike_Facilities/MapServer/0';
    let mingoGreenwayURL = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/BikeRaleigh_Map_2019_Online_WFL1/FeatureServer/7'
    let smithCreekGreenwayURL = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/BikeRaleigh_Map_2019_Online_WFL1/FeatureServer/12'
    // let chCarrboroURL = 'https://tocgis.ci.carrboro.nc.us/server/rest/services/SP/BikeSP/MapServer/0';

    // Create the query string. These are the minimum parameters needed to return valid GeoJSON of a dataset, but addtional parameters could be added to refine the query
    let queryParams = queryString({
        where: "1=1",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    let caryGreenwayQueryParams = queryString({
        where: "STATUS LIKE 'EXISTING'",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    let caryBikeQueryParams = queryString({
        where: "STATUS LIKE 'EXISTING'",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    let citrixQueryParams = queryString({
        where: "status LIKE 'open'",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    // We split up solid & dashed for durham as otherwise we would be close to the ARCGIS 1000 item limit
    let durhamSolidQueryParams = queryString({
        // We are filtering out Objectid_1 18 - 20 as they are repeats of the American Tobacco Trail
        // and they block the fact that it is not paved
        where: "(Bike_Facil LIKE 'Multiuse Path' OR Bike_Facil LIKE 'Bicycle Lane' OR Bike_Facil LIKE 'Bicycle Lane - One Side') AND (OBJECTID_1 < 18 OR OBJECTID_1 > 20)",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    let durhamDashedQueryParams = queryString({
        where: "Bike_Facil LIKE 'Shared Roadway'",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    // Some other data is in here, we only want the mingo creek greenway
    let mingoGreenwayQueryParams = queryString({
        where: "TRAIL_NAME LIKE 'Mingo Creek Greenway'",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    // let chCarrboroQueryParams = queryString({
    //     where: "BikeFac IS NOT NULL",
    //     outSR: 4326,
    //     outFields: "*",
    //     f: "geojson"
    // });

    // Generate the full query URL
    let existingRaleighGreenwaysQuery = `${existingRaleighGreenwaysURL}/query?${queryParams}`;
    let caryGreenwaysQuery = `${caryGreenwaysURL}/query?${caryGreenwayQueryParams}`;
    let caryBikeQuery = `${caryBikeURL}/query?${caryBikeQueryParams}`;
    let existingBikeFacilitiesQuery = `${existingBikeFacilities}/query?${queryParams}`;
    let programmedBikeFacilitiesQuery = `${programmedBikeFacilities}/query?${queryParams}`;
    let citrixCycleStationsQuery = `${citrixCycleStations}/query?${citrixQueryParams}`;
    let greenwayDetourQuery = 'https://gist.githubusercontent.com/jonathonwpowell/51172dccc17cf8a832ff6566e700c2d8/raw/map.geojson';
    let umsteadQuery = `${umsteadURL}/query?${queryParams}`;
    let durhamSolidQuery = 'data/osm_durham.geojson';
    let durhamDashedQuery = `${durhamURL}/query?${durhamDashedQueryParams}`;
    let mingoGreenwayQuery = `${mingoGreenwayURL}/query?${mingoGreenwayQueryParams}`;
    let smithCreekGreenwayQuery = `${smithCreekGreenwayURL}/query?${queryParams}`;
    // let chCarrboroQuery = `${chCarrboroURL}/query?${chCarrboroQueryParams}`;
    let chCarrboroQuery = 'https://gist.githubusercontent.com/jonathonwpowell/23679b5c11f8108bc1aecad157475a8f/raw/ch-carrboro-bike-facilities.geojson';

    map.on('load', () => {

        map.addSource(sources.EXISTING_FACILITIES, {
            'type': 'geojson',
            'data': existingBikeFacilitiesQuery
        });

        map.addLayer({
            'id': layers.EXISTING,
            'type': 'line',
            'source': sources.EXISTING_FACILITIES,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    'Bike Lane', 1.5,
                    'Bike Lane/Shared Lane Markings', 1.5,
                    'Buffered Bike Lane', 2,
                    'Buffered Bike Lane/Bike Lane', 2,
                    'Buffered Bike Lane/Shared Lane Markings', 2,
                    'Separated Bike Lane', 2,
                    'Multi-Use Path', 1.5,
                    0
                ]
            }
        });

        map.addLayer({
            'id': layers.EXISTING_DASHED,
            'type': 'line',
            'source': sources.EXISTING_FACILITIES,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    'Neighborhood Bikeway', 1.5,
                    'Shared Lane Markings', 1.5,
                    'Unknown', 1.5,
                    0
                ],
                'line-dasharray': [1, 2]
            }
        });

        map.addSource(sources.CARY_BIKES, {
            'type': 'geojson',
            'data': caryBikeQuery,
        });

        map.addLayer({
            'id': layers.CARY_BIKES,
            'type': 'line',
            'source': sources.CARY_BIKES,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': [
                    "match",
                    ['get', 'FACILTYTYPE'],
                    ['STRIPED'], 1.5,
                    ['PROTECTED BIKE LANES'], 2,
                    0
                ],

            }
        });

        map.addLayer({
            'id': layers.CARY_BIKES_DASHED,
            'type': 'line',
            'source': sources.CARY_BIKES,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': [
                    "match",
                    ['get', 'FACILTYTYPE'],
                    ['STRIPED', 'PROTECTED BIKE LANES'], 0,
                    1.5
                ],
                'line-opacity': [
                    "match",
                    ['get', 'SPEEDLIMIT'],
                    ["25", "25 MPH"], 1,
                    0
                ],
                'line-dasharray': [1, 2]
            }
        });

        map.addSource(sources.PROGRAMMED_FACILITIES, {
            'type': 'geojson',
            'data': programmedBikeFacilitiesQuery
        });

        map.addLayer({
            'id': layers.PROGRAMMED,
            'type': 'line',
            'source': sources.PROGRAMMED_FACILITIES,
            'layout': {},
            'paint': {
                'line-color': colors.PROGRAMMED,
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    'Bike Lane', 1.5,
                    'Bike Lane/Shared Lane Markings', 1.5,
                    'Buffered Bike Lane', 2,
                    'Buffered Bike Lane/Bike Lane', 2,
                    'Buffered Bike Lane/Shared Lane Markings', 2,
                    'Separated Bike Lane', 2,
                    'Multi-Use Path', 1.5,
                    0
                ]
            }
        });

        map.addLayer({
            'id': layers.PROGRAMMED_DASHED,
            'type': 'line',
            'source': sources.PROGRAMMED_FACILITIES,
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'Type'],
                    'Neighborhood Bikeway', colors.PROGRAMMED,
                    'Shared Lane Markings', colors.PROGRAMMED,
                    'Unknown', colors.PROGRAMMED,
                    'grey'
                ],
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    'Neighborhood Bikeway', 1.5,
                    'Shared Lane Markings', 1.5,
                    'Unknown', 1.5,
                    0
                ],
                'line-dasharray': [1, 2]
            }
        });

        map.addSource(sources.RALEIGH_GREENWAY, {
            'type': 'geojson',
            'data': existingRaleighGreenwaysQuery
        });

        map.addLayer({
            'id': layers.RALEIGH_GREENWAY,
            'type': 'line',
            'source': sources.RALEIGH_GREENWAY,
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'GWSTATUS'],
                    "CLOSED_TEMP", colors.GREENWAY_CLOSED,
                    colors.GREENWAY // We are leaving the alert status as normal, as it seems it should still be passable,
                ],
                'line-width': 1.5,
                'line-opacity': [
                    'case',
                    //This will only show if the width is greater than 6 feet AND the path material is NOT gravel / natural
                    ["all",
                        ['>', ['get', 'WIDTH_FT'], 6],
                        ["match", ["get", "MATERIAL"], ["Natural", "Gravel"], false, true]
                    ], 1,
                    0,
                ],
            }
        });

        // We are using greenway width as a guess as to how bikable a section
        // of greenway is.  If it is less than 7 ft wide we assume it is not easily bikeable
        // and make it dashed
        map.addLayer({
            'id': layers.RALEIGH_GREENWAY_DASHED,
            'type': 'line',
            'source': sources.RALEIGH_GREENWAY,
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'GWSTATUS'],
                    "CLOSED_TEMP", colors.GREENWAY_CLOSED,
                    colors.GREENWAY // We are leaving the alert status as normal, as it seems it should still be passable,
                ],
                'line-width': 1.5,
                'line-opacity': [
                    'case',
                    //This will only show if the width is less than or equal to 6 feet OR the path material is gravel / natural
                    ["all",
                        ['>', ['get', 'WIDTH_FT'], 6],
                        ["match", ["get", "MATERIAL"], ["Natural", "Gravel"], false, true]
                    ], 0,
                    1,
                ],
                'line-dasharray': [1, 2]
            }
        });

        map.addSource(sources.GREENWAY_DETOUR, {
            'type': 'geojson',
            'data': greenwayDetourQuery,
        });

        map.addLayer({
            'id': layers.GREENWAY_DETOUR,
            'type': 'line',
            'source': sources.GREENWAY_DETOUR,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY_DETOUR,
                'line-width': 1.5,
                'line-dasharray': [1, 2],
            }
        });

        map.addSource(sources.UMSTEAD, {
            'type': 'geojson',
            'data': umsteadQuery,
        });

        map.addLayer({
            'id': layers.UMSTEAD,
            'type': 'line',
            'source': sources.UMSTEAD,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-dasharray': [1, 2],
            }
        });



        map.addSource(sources.CARY_GREENWAY, {
            'type': 'geojson',
            'data': caryGreenwaysQuery
        });

        map.addLayer({
            'id': layers.CARY_GREENWAY,
            'type': 'line',
            'source': sources.CARY_GREENWAY,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-opacity': [
                    'case',
                    //This will only show if the width is greater than 6 feet AND the path material is NOT gravel / aggregate / limestone
                    ["all",
                        ['>', ['get', 'WIDTH'], 6],
                        ["match", ["get", "SURFTYPE"], ["Aggregate", "Limestone", "Gravel"], false, true]
                    ], 1,
                    0,
                ]
            }
        });

        map.addLayer({
            'id': layers.CARY_GREENWAY_DASHED,
            'type': 'line',
            'source': sources.CARY_GREENWAY,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-opacity': [
                    'case',
                    ["all",
                        ['>', ['get', 'WIDTH'], 6],
                        ["match", ["get", "SURFTYPE"], ["Aggregate", "Limestone", "Gravel"], false, true]
                    ], 0,
                    1,
                ],
                'line-dasharray': [1, 2]
            }
        });

        map.addSource(sources.DURHAM_SOLID, {
            'type': 'geojson',
            'data': durhamSolidQuery
        });

        map.addLayer({
            'id': layers.DURHAM_FACILITIES,
            'type': 'line',
            'source': sources.DURHAM_SOLID,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': 1.5,
                'line-opacity': ['case',
                    ['any',
                        ['match',
                        ['get', 'cycleway'],
                        'lane', true, false], 
                        ['match',
                        ['get', 'cycleway:left'],
                        'lane', true, false],
                        ['match',
                        ['get', 'cycleway:right'],
                        'lane', true, false],
                        ['match',
                        ['get', 'cycleway'],
                        'track', true, false]
                    ],
                    1,
                    0]
            }
        });

        map.addLayer({
            'id': layers.DURHAM_GREENWAY,
            'type': 'line',
            'source': sources.DURHAM_SOLID,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-opacity': ['case',
                    ['any',
                        ['match',
                        ['get', 'highway'],
                        'cycleway', true, false], 
                        ['match',
                        ['get', 'bicycle'],
                        'designated', true, false],
                    ],
                    1,
                    0
                ],
            }
        });

        map.addSource(sources.DURHAM_DASHED, {
            'type': 'geojson',
            'data': durhamDashedQuery
        });

        map.addLayer({
            'id': layers.DURHAM_FACILITIES_DASHED,
            'type': 'line',
            'source': sources.DURHAM_DASHED,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': 1.5,
                'line-dasharray': [1, 2],
            }
        });

        map.addSource(sources.MINGO_GREENWAY, {
            'type': 'geojson',
            'data': mingoGreenwayQuery
        });

        map.addLayer({
            'id': layers.MINGO_GREENWAY,
            'type': 'line',
            'source': sources.MINGO_GREENWAY,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
            }
        });

        map.addSource(sources.SMITH_GREENWAY, {
            'type': 'geojson',
            'data': smithCreekGreenwayQuery
        });

        map.addLayer({
            'id': layers.SMITH_GREENWAY,
            'type': 'line',
            'source': sources.SMITH_GREENWAY,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
            }
        });

        map.addSource(sources.CH_CARRBORO, {
            'type': 'geojson',
            'data': chCarrboroQuery
        });

        map.addLayer({
            'id': layers.CH_CARR_FACILITIES,
            'type': 'line',
            'source': sources.CH_CARRBORO,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': 1.5,
                'line-opacity': [
                    'match',
                    ['get', 'Bike Facility'],
                    ['Bike Lane - both sides of road', 'Bike Lane - one side of road', 'Sidepath'], 1,
                    0,
                ]
            }
        });

        map.addLayer({
            'id': layers.CH_CARR_FACILITIES_DASHED,
            'type': 'line',
            'source': sources.CH_CARRBORO,
            'layout': {},
            'paint': {
                'line-color': colors.EXISTING,
                'line-width': 1.5,
                'line-opacity': [
                    'match',
                    ['get', 'Bike Facility'],
                    ['Sharrow'], 1,
                    0,
                ],
                'line-dasharray': [1, 2],
            }
        });

        map.addLayer({
            'id': layers.CH_CARR_GREENWAY,
            'type': 'line',
            'source': sources.CH_CARRBORO,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-opacity': [
                    'match',
                    ['get', 'Bike Facility'],
                    ['Greenway - Paved',], 1,
                    0,
                ]
            }
        });

        map.addLayer({
            'id': layers.CH_CARR_GREENWAY_DASHED,
            'type': 'line',
            'source': sources.CH_CARRBORO,
            'layout': {},
            'paint': {
                'line-color': colors.GREENWAY,
                'line-width': 1.5,
                'line-opacity': [
                    'match',
                    ['get', 'Bike Facility'],
                    ['Greenway - Unpaved', 'Gravel Path', 'Trail'], 1,
                    0,
                ],
                'line-dasharray': [1, 2],
            }
        });

        map.addSource(sources.CITRIX, {
            'type': 'geojson',
            'data': citrixCycleStationsQuery
        });

        /* ---------------------Add symbol layers last so they are on top----------------------- */
        map.addLayer({
            'id': layers.CITRIX,
            'type': 'circle',
            'source': sources.CITRIX,
            'layout': {},
            'paint': {
                'circle-color': colors.CITRIX,
                'circle-radius': 4,
            }
        });

        map.addLayer({
            'id': layers.RALEIGH_GREENWAY_SYMBOL,
            'type': 'symbol',
            'source': sources.RALEIGH_GREENWAY,
            'layout': {
                'text-field': [
                    'match',
                    ['get', 'GWSTATUS'],
                    "CLOSED_TEMP", "X",
                    ""
                ],
                'symbol-placement': 'line-center',
            },
            'paint': {
                'text-color': colors.GREENWAY_CLOSED_X,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });

        map.addLayer({
            'id': layers.CARY_GREENWAY_NAME,
            'type': 'symbol',
            'source': sources.CARY_GREENWAY,
            'layout': {
                'text-field': ['get', 'NAME'],
                'symbol-placement': 'line',
                'text-size': 14,
            },
            'paint': {
                'text-color': colors.GREENWAY,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });

        map.addLayer({
            'id': layers.RALEIGH_GREENWAY_NAME,
            'type': 'symbol',
            'source': sources.RALEIGH_GREENWAY,
            'layout': {
                'text-field': ['get', 'TRAIL_NAME'],
                'symbol-placement': 'line',
                'text-size': 14,
            },
            'paint': {
                'text-color': colors.GREENWAY,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });

        map.addLayer({
            'id': layers.MINGO_GREENWAY_NAMES,
            'type': 'symbol',
            'source': sources.MINGO_GREENWAY,
            'layout': {
                'text-field': ['get', 'TRAIL_NAME'],
                'symbol-placement': 'line',
                'text-size': 14,
            },
            'paint': {
                'text-color': colors.GREENWAY,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });

        map.addLayer({
            'id': layers.SMITH_GREENWAY_NAMES,
            'type': 'symbol',
            'source': sources.SMITH_GREENWAY,
            'layout': {
                'text-field': ['get', 'Street'],
                'symbol-placement': 'line',
                'text-size': 14,
            },
            'paint': {
                'text-color': colors.GREENWAY,
                'text-halo-width': 1,
                'text-halo-color': 'black',
            },
        });

        // After the map has started loading and all the layers have been added
        // we want to disable any layers the user previously removed
        if (getCookie("hasOpened")) {
            if (getCookie("hideGreenway") === "true") {
                legendToggleGreenwayLayer(false);
                document.getElementById('greenway-checkbox').checked = false;
            }
            if (getCookie("hideGreenwayDashed") === "true") {
                legendToggleGreenwayDashedLayer(false);
                document.getElementById('greenway-dashed-checkbox').checked = false;
            }
            if (getCookie("hideGreenwayDetour") === "true") {
                legendToggleGreenwayDetourLayer(false);
                document.getElementById('greenway-detour-checkbox').checked = false;
            }
            if (getCookie("hideFacilities") === "true") {
                legendToggleFacilitiesLayer(false);
                document.getElementById('facilities-checkbox').checked = false;
            }
            if (getCookie("hideFacilitiesDashed") === "true") {
                legendToggleDashedFacilitiesLayer(false);
                document.getElementById('facilities-dashed-checkbox').checked = false;
            }
            if (getCookie("hideCitrix") === "true") {
                legendToggleCitrixLayer(false);
                document.getElementById('citrix-checkbox').checked = false;
            }
            if (getCookie("hideProgrammed") === "true") {
                legendToggleProgrammedLayer(false);
                document.getElementById('programmed-checkbox').checked = false;
            }
        } else {
            setCookie("hasOpened","true",1000);
            // We default the programmed bike infra to not show
            legendToggleProgrammedLayer(false);
            document.getElementById('programmed-checkbox').checked = false;
        }

        map.resize();
    });

    function legendToggleGreenwayLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideGreenway",(!isChecked).toString(),1000);

        map.setLayoutProperty(layers.RALEIGH_GREENWAY, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CARY_GREENWAY, 'visibility', visibilityState);
        map.setLayoutProperty(layers.MINGO_GREENWAY, 'visibility', visibilityState);
        map.setLayoutProperty(layers.SMITH_GREENWAY, 'visibility', visibilityState);
        map.setLayoutProperty(layers.DURHAM_GREENWAY, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CH_CARR_GREENWAY, 'visibility', visibilityState);
        map.setLayoutProperty(layers.RALEIGH_GREENWAY_SYMBOL, 'visibility', visibilityState);
    }

    function legendToggleGreenwayDashedLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideGreenwayDashed",(!isChecked).toString(),1000);

        map.setLayoutProperty(layers.RALEIGH_GREENWAY_DASHED, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CARY_GREENWAY_DASHED, 'visibility', visibilityState);
        map.setLayoutProperty(layers.UMSTEAD, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CH_CARR_GREENWAY_DASHED, 'visibility', visibilityState);
    }

    function legendToggleGreenwayDetourLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideGreenwayDetour",(!isChecked).toString(),1000);

        map.setLayoutProperty(layers.GREENWAY_DETOUR, 'visibility', visibilityState);
    }

    function legendToggleFacilitiesLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideFacilities",(!isChecked).toString(),1000);

        map.setLayoutProperty(layers.EXISTING, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CARY_BIKES, 'visibility', visibilityState);
        map.setLayoutProperty(layers.DURHAM_FACILITIES, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CH_CARR_FACILITIES, 'visibility', visibilityState);
    }

    function legendToggleDashedFacilitiesLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideFacilitiesDashed",(!isChecked).toString(),1000);

        map.setLayoutProperty(layers.EXISTING_DASHED, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CARY_BIKES_DASHED, 'visibility', visibilityState);
        map.setLayoutProperty(layers.DURHAM_FACILITIES_DASHED, 'visibility', visibilityState);
        map.setLayoutProperty(layers.CH_CARR_FACILITIES_DASHED, 'visibility', visibilityState);
    }

    function legendToggleProgrammedLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideProgrammed",(!isChecked).toString(),1000);

        map.setLayoutProperty(layers.PROGRAMMED, 'visibility', visibilityState);
        map.setLayoutProperty(layers.PROGRAMMED_DASHED, 'visibility', visibilityState);
    }

    function legendToggleCitrixLayer(isChecked) {
        var visibilityState = isChecked ? 'visible' : 'none';
        setCookie("hideCitrix",(!isChecked).toString(),1000);

        map.setLayoutProperty(layers.CITRIX, 'visibility', visibilityState);
    }

    function toggleDirectionSection() {
        if (showingDirectionsSection) {
            document.getElementsByClassName('mapboxgl-ctrl-directions')[0].style.display = 'none';
            document.getElementById('show-directions-container').style.display = 'block';
            document.getElementById('direction-buttons').style.display = 'none';
            directionContol.interactive(false);
            showingDirectionsSection = false;
        } else {
            document.getElementsByClassName('mapboxgl-ctrl-directions')[0].style.display = 'block';
            document.getElementById('show-directions-container').style.display = 'none';
            document.getElementById('direction-buttons').style.display = 'block';
            directionContol.interactive(true);
            showingDirectionsSection = true;
        }
    }

    function setNavOrigin() {
        var options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 1000,
        };
        navigator.geolocation.getCurrentPosition(
            (geoPos) => {
                var currPosition = [geoPos.coords.longitude, geoPos.coords.latitude];
                directionContol.setOrigin(currPosition);
            },
            (err) => {
                console.warn("Error finding position: " + err.message);
                if (lastFoundPosition) {
                    directionContol.setOrigin(lastFoundPosition);
                };
                if (err.code == 1) {
                    window.alert("Access to the devices location was blocked, please enable to use location services.")
                };
            }, options);
    }

    function setCookie(name,value,days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }

    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }



</script>

</html>
